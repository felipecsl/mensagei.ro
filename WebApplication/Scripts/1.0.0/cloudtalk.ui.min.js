var sClientName,sClientEmail,ePanelLogin,ePanelMessages,eDivMessages,eTxtMessage,eTxtName,eTxtEmail,eBtnSubmit,eBtnJoin,eLoadingImage,eLabelQueue,eLabelQueueSize,eBtnSair,bWaitingToJoin,bHasFocus,bMsgIndex,titleChanger,titleMessages;bWaitingToJoin=false;bHasFocus=false;bMsgIndex=false;titleMessages=["Atendimento Online","Atendimento Online"];var cloudTalk=new CloudTalk(sBaseURL);$(function(){ePanelLogin=$("#login-panel");ePanelMessages=$("#messages-panel");eDivMessages=$("#msgs-panel");eTxtMessage=$("textarea#input-area");eTxtName=$("input#txt-name");eTxtEmail=$("input#txt-email");eLoadingImage=$(".loading-image");eBtnSubmit=$("input#submit-button");eBtnJoin=$("input#enter-button");eLabelQueue=$("span#queue-indicator");eLabelQueueSize=$("span#queue-size");eBtnSair=$("#btnSair");eLoadingImage.hide();ePanelMessages.hide();eLabelQueue.hide();if(bIsOnline=="False"||bIsInvalid=="True"){$("div.not-available").show();ePanelLogin.hide()}eTxtMessage.keypress(onKeyPress);eBtnJoin.click(onJoinRoom);eBtnSubmit.click(onClickSubmit);eBtnSair.click(onClickExit);$(window).bind("focus",gainedFocus).bind("blur",function(){bHasFocus=false;console.log("lost focus")})});function gainedFocus(){bHasFocus=true;clearInterval(titleChanger);titleChanger=-1;document.title=titleMessages[0]}function changeTitle(a){if(bHasFocus){return}if(titleChanger>0){return}titleMessages[1]=a;titleChanger=setInterval(function(){bMsgIndex=!bMsgIndex;document.title=titleMessages[+bMsgIndex]},1500)}function onKeyPress(b){var c=(b)?b:event;var a=(b.which)?b.which:b.keyCode;if(a==13&&!c.shiftKey){c.preventDefault();eBtnSubmit.click()}bHasFocus=true}function onClickSubmit(){cloudTalk.sendMessage(sRoomName,sClientEmail,eTxtMessage.val());appendOwnMessage(sClientName,Utils.getTime(),eTxtMessage.val());eTxtMessage.val("")}function onJoinRoom(a){a.preventDefault();if(eTxtName.val()==""||eTxtEmail.val()==""){alert("Favor preencher todos os campos");return}if(!Utils.isValidEmail(eTxtEmail.val())){alert("Favor preencher um endereço de email válido");return}eLoadingImage.show();sClientName=eTxtName.val();sClientEmail=eTxtEmail.val();cloudTalk.joinRoom(sRoomName,sClientName,sClientEmail,onRoomJoined,onRoomJoinFailed)}function onRoomJoined(a,d){eLoadingImage.hide();var c=a.Code;var b=a.Message;if(c==3){eLabelQueue.show();eLabelQueueSize.text(a.Position);eBtnJoin.hide();bWaitingToJoin=true;getEvents();setUpQuitConfirmation();return}else{if(c!=1){alert(b)}else{setUpChat();getEvents()}}}function setUpChat(){ePanelLogin.hide("normal");ePanelMessages.show("normal");setUpQuitConfirmation();if(bIsHost=="False"){appendAdminMsg("Bem vindo, "+sClientName+". Em que posso ajudar?")}}function setUpQuitConfirmation(){window.onbeforeunload=function(){return"Se você sair, suas mensagens não serão mantidas!"};$(window).bind("unload",function(){cloudTalk.leaveRoom(sRoomName,sClientEmail)})}function onClickExit(){cloudTalk.leaveRoom(sRoomName,sClientEmail);ePanelMessages.hide();$("div.thanks").show();$(window).unbind("unload");window.onbeforeunload=null}function onRoomJoinFailed(b,c,a){eLoadingImage.hide();alert(b.responseText)}function getEvents(){cloudTalk.getEvents(sClientEmail,onEventsComplete,getEvents)}function appendAdminMsg(a){appendText('<div class="message">'+Utils.formatMessage(a)+"</div>")}function appendOwnMessage(a,b,c){appendText('<div class="message"><span class="client">'+a+" ("+b+"): </span>"+Utils.formatMessage(c)+"</div>")}function appendMessage(a,b,c){changeTitle(a+" diz...");appendText('<div class="message"><span>'+a+" ("+b+"): </span>"+Utils.formatMessage(c)+"</div>")}function appendText(a){eDivMessages.append(a);eDivMessages[0].scrollTop=eDivMessages[0].scrollHeight}function onEventsComplete(d){var c=d;if(c==null){return}for(var b=0;b<c.length;b++){var a=c[b];var e=a.EventType;if(bWaitingToJoin&&e=="RoomSpaceAvailable"){setUpChat()}else{if(e=="QueueSizeChanged"){var f=JSON.parse(a.EventObject);eLabelQueueSize.text(f.QueueSize)}else{if(e=="Message"||e=="EnterRoom"||e=="LeaveRoom"){var f=JSON.parse(a.EventObject);appendMessage(a.Sender,a.Timestamp,f.Message);$.sound.play(sTunePath);if(e=="LeaveRoom"&&bIsHost=="False"){onClickExit()}}}}}getEvents()};